<div class="wrapper">
    <app-sidebar></app-sidebar>
    <div class="main">
        <app-header></app-header>
        <main class="content px-3 py-2">
            <div class="container-fluid">
                <div class="card border-0">
                    <div class="p-4 mt-5">
                        <div class="container">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h1>
                                    <i class="bi bi-people-fill me-2"></i>
                                    Liste des Jurys - Stage de Perfectionnement
                                </h1>
                                <button class="btn btn-primary" (click)="generateAffectations()" [disabled]="loading">
                                    <i class="bi bi-arrow-repeat me-1"></i>{{ loading ? 'Génération en cours...' : 'Générer les affectations' }}
                                </button>
                            </div>
                            <button class="btn btn-success me-2" (click)="exportToExcel()" [disabled]="!affectations || affectations.length === 0">
                                <i class="bi bi-file-earmark-excel-fill"></i> Exporter Excel
                            </button>
                            <div *ngIf="message" class="alert alert-dismissible fade show" 
                                 [class.alert-success]="messageType === 'success'"
                                 [class.alert-danger]="messageType === 'error'">
                                {{ message }}
                                <button type="button" class="btn-close" (click)="message = null"></button>
                            </div>

                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Jury</th>
                                        <th>Salle</th>
                                        <th>Étudiant(e)</th>
                                        <th>Classe</th>
                                        <th>Stage</th>
                                        <th>Action Étudiant</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngIf="!affectations || affectations.length === 0">
                                        <td colspan="7" class="text-center py-4">
                                            <div class="d-flex flex-column align-items-center">
                                                <i class="bi bi-exclamation-circle-fill text-muted mb-2" style="font-size: 2rem;"></i>
                                                <h5 class="text-muted">Aucune donnée disponible</h5>
                                                <p class="text-muted mb-3">Veuillez générer les affectations</p>
                                            </div>
                                        </td>
                                    </tr>
                                    <ng-container *ngFor="let aff of affectations; trackBy: trackByAffectationId">
                                        <tr *ngFor="let etu of aff.etudiants; let i = index">
                                            <td *ngIf="i === 0" [attr.rowspan]="aff.etudiants.length">
                                                <strong>{{ aff.juryLabel }} :</strong><br>
                                                {{ aff.enseignants.join(' & ') }}
                                            </td>
                                            <td *ngIf="i === 0" [attr.rowspan]="aff.etudiants.length">
                                                {{ aff.salle }}
                                            </td>
                                            <td>{{ etu.nom }}</td>
                                            <td>{{ etu.classe }}</td>
                                            <td>{{ aff.stageType }}</td>
                                            <td>
                                                <div class="d-flex justify-content-center">
                                                    <div class="btn-group btn-group">
                                                        <button class="btn btn-outline-primary py-0 px-2" 
                                                                (click)="openEditEtudiantModal(editEtudiantModal, aff, i)">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger py-0 px-2" 
                                                                (click)="removeEtudiant(aff._id, i)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </td>
                                            <td *ngIf="i === 0" [attr.rowspan]="aff.etudiants.length">
                                                <div class="d-flex justify-content-center">
                                                    <button class="btn btn-sm btn-outline-primary py-0 px-2" 
                                                            (click)="openEditModal(editModal, aff)">
                                                        <i class="bi bi-pencil-square"></i> Modifier
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </ng-container>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Modal pour modifier le jury -->
<ng-template #editModal let-modal>
    <div class="modal-header bg-light">
        <h5 class="modal-title">
            <i class="bi bi-pencil me-2"></i>
            Modifier le jury {{ selectedAffectation?.juryLabel }}
        </h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.close()"></button>
    </div>
    <div class="modal-body">
        <form [formGroup]="editForm">
            <div *ngIf="formError" class="alert alert-danger mb-3">
                <i class="bi bi-exclamation-triangle-fill"></i> 
                {{ formError }}
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Enseignant 1 *</label>
                    <select class="form-select" formControlName="enseignant1" 
                        [class.is-invalid]="enseignant1?.invalid && (enseignant1?.dirty || enseignant1?.touched)">
                        <option value="">Sélectionner...</option>
                        <option *ngFor="let ens of enseignantOptions" [value]="ens">
                            {{ ens }}
                        </option>
                    </select>
                    <div class="invalid-feedback" *ngIf="enseignant1?.invalid">
                        Sélection requise
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Enseignant 2 *</label>
                    <select class="form-select" formControlName="enseignant2" 
                        [class.is-invalid]="enseignant2?.invalid && (enseignant2?.dirty || enseignant2?.touched)">
                        <option value="">Sélectionner...</option>
                        <option *ngFor="let ens of enseignantOptions" [value]="ens">
                            {{ ens }}
                        </option>
                    </select>
                    <div class="invalid-feedback" *ngIf="enseignant2?.invalid">
                        Sélection requise
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Salle *</label>
                    <input type="text" class="form-control" formControlName="salle" 
                        [class.is-invalid]="salle?.invalid && (salle?.dirty || salle?.touched)"
                        placeholder="Ex: B01">
                    <div class="invalid-feedback" *ngIf="salle?.errors?.['required']">
                        La salle est requise
                    </div>
                    <div class="invalid-feedback" *ngIf="salle?.errors?.['pattern']">
                        Format: B ou INFO B suivi de 2 chiffres (ex: B05)
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="modal.close()">
            <i class="bi bi-x-circle me-1"></i> Annuler
        </button>
        <button type="button" class="btn btn-primary" (click)="saveChanges()">
            <i class="bi bi-check-circle me-1"></i> Enregistrer
        </button>
    </div>
</ng-template>

<!-- Modal pour modifier un étudiant -->
<ng-template #editEtudiantModal let-modal>
   <div class="modal-header bg-light">
        <h5 class="modal-title">
            <i class="bi bi-person-gear me-2"></i>
            Modifier l'étudiant
        </h5>
        <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
    </div>
    <div class="modal-body">
        <form [formGroup]="etudiantForm">
            <div *ngIf="etudiantFormError" class="alert alert-danger mb-3">
                <i class="bi bi-exclamation-triangle-fill"></i> 
                {{ etudiantFormError }}
            </div>
            <div class="mb-3">
                <label class="form-label">Classe *</label>
                <select class="form-select" formControlName="classe" (change)="onClasseChange(etudiantClasse?.value)">
                    <option value="">Sélectionner une classe...</option>
                    <option *ngFor="let classe of classesList" [value]="classe">
                        {{ classe }}
                    </option>
                </select>
                <div *ngIf="etudiantClasse?.invalid && (etudiantClasse?.dirty || etudiantClasse?.touched)" 
                     class="text-danger small mt-1">
                    La classe est requise
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Étudiant *</label>
                <select class="form-select" formControlName="nom" [disabled]="!etudiantClasse?.value || filteredEtudiants.length === 0">
                    <option value="">Sélectionner un étudiant...</option>
                    <option *ngFor="let etu of filteredEtudiants" [value]="etu.nomComplet">
                        {{ etu.nomComplet }}
                    </option>
                </select>
                <div *ngIf="etudiantClasse?.value && filteredEtudiants.length === 0" 
                     class="text-muted small mt-1">
                    Aucun étudiant trouvé dans cette classe
                </div>
                <div *ngIf="etudiantNom?.invalid && (etudiantNom?.dirty || etudiantNom?.touched)" 
                     class="text-danger small mt-1">
                    L'étudiant est requis
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">
            <i class="bi bi-x-circle me-1"></i> Annuler
        </button>
        <button type="button" class="btn btn-primary" (click)="saveEtudiantChanges()">
            <i class="bi bi-check-circle me-1"></i> Enregistrer
        </button>
    </div>
</ng-template>